<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>StreamSync - Real-time Data Streaming</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 100%);
      color: #fff;
      min-height: 100vh;
      padding: 20px;
    }
    .container { max-width: 1000px; margin: 0 auto; }
    h1 {
      font-size: 1.5rem;
      margin-bottom: 4px;
      background: linear-gradient(90deg, #8b5cf6, #a855f7);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .subtitle { color: #888; font-size: 0.875rem; margin-bottom: 20px; }
    .live-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      background: rgba(34, 197, 94, 0.15);
      border: 1px solid rgba(34, 197, 94, 0.3);
      border-radius: 999px;
      font-size: 0.7rem;
      color: #22c55e;
      margin-left: 12px;
      vertical-align: middle;
    }
    .live-badge::before {
      content: '';
      width: 6px;
      height: 6px;
      background: #22c55e;
      border-radius: 50%;
      animation: pulse 1s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(1.2); }
    }

    .connection-status {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px;
      background: rgba(139, 92, 246, 0.1);
      border: 1px solid rgba(139, 92, 246, 0.2);
      border-radius: 12px;
      margin-bottom: 20px;
    }
    .status-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .stream-badge {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      background: rgba(139, 92, 246, 0.2);
      border-radius: 8px;
      font-size: 0.75rem;
      color: #a855f7;
    }
    .stream-badge svg { width: 16px; height: 16px; }
    .status-indicator {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.75rem;
    }
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #666;
    }
    .status-dot.connected { background: #22c55e; animation: pulse 2s infinite; }
    .status-dot.connecting { background: #f59e0b; animation: pulse 0.5s infinite; }
    .status-dot.error { background: #ef4444; }
    .status-right {
      display: flex;
      gap: 20px;
      font-size: 0.75rem;
      color: #888;
    }
    .stat-item { display: flex; flex-direction: column; align-items: center; }
    .stat-value { font-size: 1rem; font-weight: 700; color: #fff; }
    .stat-label { font-size: 0.65rem; color: #666; text-transform: uppercase; }

    .streams-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-bottom: 20px;
    }
    .stream-card {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 16px;
      transition: all 0.3s;
    }
    .stream-card.highlight {
      border-color: rgba(139, 92, 246, 0.5);
      box-shadow: 0 0 20px rgba(139, 92, 246, 0.2);
    }
    .stream-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    .stream-symbol {
      font-size: 0.9rem;
      font-weight: 700;
      color: #fff;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .coin-icon {
      width: 24px;
      height: 24px;
      border-radius: 50%;
    }
    .stream-change {
      font-size: 0.75rem;
      padding: 2px 8px;
      border-radius: 4px;
      font-weight: 600;
    }
    .stream-change.positive { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
    .stream-change.negative { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
    .stream-price {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 8px;
      font-family: 'Monaco', 'Menlo', monospace;
      transition: color 0.3s;
    }
    .stream-price.up { color: #22c55e; }
    .stream-price.down { color: #ef4444; }
    .stream-meta {
      display: flex;
      justify-content: space-between;
      font-size: 0.7rem;
      color: #666;
    }
    .mini-chart {
      height: 40px;
      margin-top: 12px;
      display: flex;
      align-items: flex-end;
      gap: 2px;
    }
    .chart-bar {
      flex: 1;
      background: rgba(139, 92, 246, 0.3);
      border-radius: 2px 2px 0 0;
      transition: height 0.3s;
    }

    .data-flow-section {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 20px;
    }
    .flow-panel {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      overflow: hidden;
    }
    .flow-header {
      padding: 12px 16px;
      background: rgba(0,0,0,0.2);
      border-bottom: 1px solid rgba(255,255,255,0.1);
      font-size: 0.75rem;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .flow-body {
      padding: 12px 16px;
      height: 180px;
      overflow-y: auto;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 0.65rem;
    }
    .message-entry {
      padding: 6px 8px;
      margin-bottom: 4px;
      border-radius: 4px;
      background: rgba(255,255,255,0.02);
      border-left: 2px solid #8b5cf6;
      opacity: 0;
      animation: fadeIn 0.3s forwards;
    }
    .message-entry.outgoing { border-left-color: #22c55e; }
    @keyframes fadeIn { to { opacity: 1; } }
    .msg-time { color: #666; }
    .msg-data { color: #888; }

    .throughput-chart {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .throughput-row {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .throughput-label {
      width: 100px;
      font-size: 0.7rem;
      color: #888;
    }
    .throughput-bar-container {
      flex: 1;
      height: 16px;
      background: rgba(255,255,255,0.05);
      border-radius: 4px;
      overflow: hidden;
    }
    .throughput-bar {
      height: 100%;
      border-radius: 4px;
      transition: width 0.5s ease;
    }
    .throughput-value {
      width: 60px;
      text-align: right;
      font-size: 0.7rem;
      font-weight: 600;
    }

    .controls {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
    }
    .btn {
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 0.8rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }
    .btn-primary {
      background: linear-gradient(135deg, #8b5cf6, #7c3aed);
      color: white;
    }
    .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4); }
    .btn-secondary {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      color: white;
    }
    .btn-danger {
      background: rgba(239, 68, 68, 0.2);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: #ef4444;
    }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }

    .api-note {
      font-size: 0.65rem;
      color: #666;
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .error-banner {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: #ef4444;
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 0.8rem;
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>StreamSync <span class="live-badge">LIVE STREAM</span></h1>
    <p class="subtitle">Real-time cryptocurrency price streaming with polling sync</p>

    <div class="error-banner" id="errorBanner"></div>

    <div class="controls">
      <button class="btn btn-primary" id="connectBtn" onclick="toggleStreaming()">Start Streaming</button>
      <button class="btn btn-secondary" onclick="clearLogs()">Clear Logs</button>
      <span class="api-note">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"/>
          <path d="M12 6v6l4 2"/>
        </svg>
        Data source: CoinGecko API (live crypto prices, 3s refresh)
      </span>
    </div>

    <div class="connection-status">
      <div class="status-left">
        <div class="stream-badge">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M5 12h14M12 5l7 7-7 7"/>
          </svg>
          REST Polling
        </div>
        <div class="status-indicator">
          <div class="status-dot" id="statusDot"></div>
          <span id="statusText">Idle</span>
        </div>
        <span id="apiUrl" style="font-size: 0.7rem; color: #666;">api.coingecko.com/api/v3</span>
      </div>
      <div class="status-right">
        <div class="stat-item">
          <div class="stat-value" id="updateRate">0</div>
          <div class="stat-label">Updates/min</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="totalUpdates">0</div>
          <div class="stat-label">Total Updates</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="dataReceived">0 KB</div>
          <div class="stat-label">Data Recv</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="uptime">0:00</div>
          <div class="stat-label">Uptime</div>
        </div>
      </div>
    </div>

    <div class="streams-grid" id="streamsGrid">
      <div class="stream-card" data-symbol="bitcoin">
        <div class="stream-header">
          <span class="stream-symbol">
            <img class="coin-icon" src="https://assets.coingecko.com/coins/images/1/small/bitcoin.png" alt="BTC">
            BTC/USD
          </span>
          <span class="stream-change" id="btc-change">--</span>
        </div>
        <div class="stream-price" id="btc-price">$--</div>
        <div class="stream-meta">
          <span>Vol: <span id="btc-volume">--</span></span>
          <span>MCap: <span id="btc-mcap">--</span></span>
        </div>
        <div class="mini-chart" id="btc-chart"></div>
      </div>

      <div class="stream-card" data-symbol="ethereum">
        <div class="stream-header">
          <span class="stream-symbol">
            <img class="coin-icon" src="https://assets.coingecko.com/coins/images/279/small/ethereum.png" alt="ETH">
            ETH/USD
          </span>
          <span class="stream-change" id="eth-change">--</span>
        </div>
        <div class="stream-price" id="eth-price">$--</div>
        <div class="stream-meta">
          <span>Vol: <span id="eth-volume">--</span></span>
          <span>MCap: <span id="eth-mcap">--</span></span>
        </div>
        <div class="mini-chart" id="eth-chart"></div>
      </div>

      <div class="stream-card" data-symbol="solana">
        <div class="stream-header">
          <span class="stream-symbol">
            <img class="coin-icon" src="https://assets.coingecko.com/coins/images/4128/small/solana.png" alt="SOL">
            SOL/USD
          </span>
          <span class="stream-change" id="sol-change">--</span>
        </div>
        <div class="stream-price" id="sol-price">$--</div>
        <div class="stream-meta">
          <span>Vol: <span id="sol-volume">--</span></span>
          <span>MCap: <span id="sol-mcap">--</span></span>
        </div>
        <div class="mini-chart" id="sol-chart"></div>
      </div>
    </div>

    <div class="data-flow-section">
      <div class="flow-panel">
        <div class="flow-header">
          <span>ðŸ“¥ API Response Log</span>
          <span id="incomingCount">0 responses</span>
        </div>
        <div class="flow-body" id="incomingLog"></div>
      </div>

      <div class="flow-panel">
        <div class="flow-header">
          <span>ðŸ“Š Stream Throughput</span>
          <span id="throughputLabel">Per update cycle</span>
        </div>
        <div class="flow-body">
          <div class="throughput-chart">
            <div class="throughput-row">
              <span class="throughput-label">Bitcoin</span>
              <div class="throughput-bar-container">
                <div class="throughput-bar" id="btc-throughput" style="width: 0%; background: #f59e0b;"></div>
              </div>
              <span class="throughput-value" id="btc-rate">--</span>
            </div>
            <div class="throughput-row">
              <span class="throughput-label">Ethereum</span>
              <div class="throughput-bar-container">
                <div class="throughput-bar" id="eth-throughput" style="width: 0%; background: #8b5cf6;"></div>
              </div>
              <span class="throughput-value" id="eth-rate">--</span>
            </div>
            <div class="throughput-row">
              <span class="throughput-label">Solana</span>
              <div class="throughput-bar-container">
                <div class="throughput-bar" id="sol-throughput" style="width: 0%; background: #22c55e;"></div>
              </div>
              <span class="throughput-value" id="sol-rate">--</span>
            </div>
            <div class="throughput-row" style="margin-top: 16px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.1);">
              <span class="throughput-label" style="font-weight: 600;">Avg Latency</span>
              <div class="throughput-bar-container">
                <div class="throughput-bar" id="latency-bar" style="width: 0%; background: linear-gradient(90deg, #22c55e, #f59e0b);"></div>
              </div>
              <span class="throughput-value" id="latency-value" style="color: #fff;">--</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let isStreaming = false;
    let streamInterval = null;
    let totalUpdates = 0;
    let totalBytes = 0;
    let priceHistory = { btc: [], eth: [], sol: [] };
    let lastPrices = { btc: 0, eth: 0, sol: 0 };
    let startTime = null;
    let updatesThisMinute = 0;
    let lastMinuteReset = Date.now();

    // Initialize mini charts
    ['btc', 'eth', 'sol'].forEach(symbol => {
      const chart = document.getElementById(`${symbol}-chart`);
      for (let i = 0; i < 20; i++) {
        const bar = document.createElement('div');
        bar.className = 'chart-bar';
        bar.style.height = '20%';
        chart.appendChild(bar);
      }
    });

    function toggleStreaming() {
      if (isStreaming) {
        stopStreaming();
      } else {
        startStreaming();
      }
    }

    function startStreaming() {
      isStreaming = true;
      startTime = Date.now();
      updateStatus('connecting', 'Connecting...');
      document.getElementById('connectBtn').textContent = 'Connecting...';
      document.getElementById('connectBtn').disabled = true;

      // Initial fetch
      fetchPrices().then(() => {
        updateStatus('connected', 'Streaming');
        document.getElementById('connectBtn').textContent = 'Stop Streaming';
        document.getElementById('connectBtn').disabled = false;
        document.getElementById('connectBtn').classList.remove('btn-primary');
        document.getElementById('connectBtn').classList.add('btn-danger');
        addMessage('Connected to CoinGecko API - streaming started', 'system');

        // Start polling every 3 seconds
        streamInterval = setInterval(fetchPrices, 3000);
      }).catch(err => {
        updateStatus('error', 'Connection failed');
        document.getElementById('connectBtn').textContent = 'Start Streaming';
        document.getElementById('connectBtn').disabled = false;
        showError(`Failed to connect: ${err.message}`);
        isStreaming = false;
      });
    }

    function stopStreaming() {
      isStreaming = false;
      if (streamInterval) {
        clearInterval(streamInterval);
        streamInterval = null;
      }
      updateStatus('disconnected', 'Stopped');
      document.getElementById('connectBtn').textContent = 'Start Streaming';
      document.getElementById('connectBtn').classList.add('btn-primary');
      document.getElementById('connectBtn').classList.remove('btn-danger');
      addMessage('Stream stopped', 'system');
    }

    async function fetchPrices() {
      const startFetch = performance.now();

      try {
        const response = await fetch(
          'https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ethereum,solana&vs_currencies=usd&include_24hr_change=true&include_24hr_vol=true&include_market_cap=true'
        );

        if (!response.ok) {
          throw new Error(`API returned ${response.status}`);
        }

        const data = await response.json();
        const latency = Math.round(performance.now() - startFetch);
        const dataSize = new Blob([JSON.stringify(data)]).size;

        totalBytes += dataSize;
        totalUpdates++;
        updatesThisMinute++;

        document.getElementById('totalUpdates').textContent = totalUpdates;
        document.getElementById('dataReceived').textContent = formatBytes(totalBytes);

        // Update latency bar
        const maxLatency = 1000;
        const latencyPercent = Math.min((latency / maxLatency) * 100, 100);
        document.getElementById('latency-bar').style.width = `${latencyPercent}%`;
        document.getElementById('latency-value').textContent = `${latency}ms`;

        // Process each coin
        processCoinData('btc', 'bitcoin', data.bitcoin, latency);
        processCoinData('eth', 'ethereum', data.ethereum, latency);
        processCoinData('sol', 'solana', data.solana, latency);

        // Add log entry
        addMessage(`Fetched prices: BTC=$${data.bitcoin.usd.toLocaleString()}, ETH=$${data.ethereum.usd.toLocaleString()}, SOL=$${data.solana.usd.toFixed(2)} (${latency}ms)`, 'data');

        hideError();

      } catch (error) {
        console.error('Fetch error:', error);
        addMessage(`Error: ${error.message}`, 'error');
        showError(error.message);
      }
    }

    function processCoinData(prefix, coinId, data, latency) {
      if (!data) return;

      const price = data.usd;
      const change = data.usd_24h_change || 0;
      const volume = data.usd_24h_vol || 0;
      const mcap = data.usd_market_cap || 0;

      // Determine price direction
      const prevPrice = lastPrices[prefix];
      const direction = price > prevPrice ? 'up' : price < prevPrice ? 'down' : '';
      lastPrices[prefix] = price;

      // Update UI
      const priceEl = document.getElementById(`${prefix}-price`);
      priceEl.textContent = `$${price.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
      priceEl.className = `stream-price ${direction}`;

      const changeEl = document.getElementById(`${prefix}-change`);
      changeEl.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(2)}%`;
      changeEl.className = `stream-change ${change >= 0 ? 'positive' : 'negative'}`;

      document.getElementById(`${prefix}-volume`).textContent = formatVolume(volume);
      document.getElementById(`${prefix}-mcap`).textContent = formatVolume(mcap);

      // Update price history for chart
      priceHistory[prefix].push(price);
      if (priceHistory[prefix].length > 20) priceHistory[prefix].shift();
      updateMiniChart(prefix);

      // Update throughput bar (based on price movement)
      const movement = prevPrice > 0 ? Math.abs((price - prevPrice) / prevPrice) * 10000 : 0;
      const throughputPercent = Math.min(movement, 100);
      document.getElementById(`${prefix}-throughput`).style.width = `${Math.max(throughputPercent, 10)}%`;
      document.getElementById(`${prefix}-rate`).textContent = `$${price.toLocaleString(undefined, { maximumFractionDigits: 0 })}`;

      // Highlight card
      const card = document.querySelector(`[data-symbol="${coinId}"]`);
      card.classList.add('highlight');
      setTimeout(() => card.classList.remove('highlight'), 300);
    }

    function updateMiniChart(symbol) {
      const history = priceHistory[symbol];
      if (history.length < 2) return;

      const min = Math.min(...history);
      const max = Math.max(...history);
      const range = max - min || 1;

      const chart = document.getElementById(`${symbol}-chart`);
      const bars = chart.children;

      for (let i = 0; i < 20; i++) {
        const price = history[history.length - 20 + i];
        if (price !== undefined) {
          const height = ((price - min) / range) * 80 + 20;
          bars[i].style.height = `${height}%`;
        }
      }
    }

    function addMessage(text, type = 'data') {
      const log = document.getElementById('incomingLog');
      const entry = document.createElement('div');
      entry.className = `message-entry ${type === 'system' ? 'outgoing' : ''}`;

      const time = new Date().toLocaleTimeString();
      entry.innerHTML = `<span class="msg-time">[${time}]</span> <span class="msg-data">${text}</span>`;

      log.insertBefore(entry, log.firstChild);
      if (log.children.length > 50) log.removeChild(log.lastChild);

      document.getElementById('incomingCount').textContent = `${Math.min(log.children.length, 50)} responses`;
    }

    function updateStatus(status, text) {
      const dot = document.getElementById('statusDot');
      dot.className = `status-dot ${status}`;
      document.getElementById('statusText').textContent = text;
    }

    function formatBytes(bytes) {
      if (bytes < 1024) return `${bytes} B`;
      if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;
      return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;
    }

    function formatVolume(vol) {
      if (vol >= 1e12) return `$${(vol / 1e12).toFixed(1)}T`;
      if (vol >= 1e9) return `$${(vol / 1e9).toFixed(1)}B`;
      if (vol >= 1e6) return `$${(vol / 1e6).toFixed(1)}M`;
      if (vol >= 1e3) return `$${(vol / 1e3).toFixed(1)}K`;
      return `$${vol.toFixed(0)}`;
    }

    function clearLogs() {
      document.getElementById('incomingLog').innerHTML = '';
      document.getElementById('incomingCount').textContent = '0 responses';
    }

    function showError(message) {
      const banner = document.getElementById('errorBanner');
      banner.textContent = message;
      banner.style.display = 'block';
    }

    function hideError() {
      document.getElementById('errorBanner').style.display = 'none';
    }

    // Update uptime and rate every second
    setInterval(() => {
      if (isStreaming && startTime) {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        const mins = Math.floor(elapsed / 60);
        const secs = elapsed % 60;
        document.getElementById('uptime').textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
      }

      // Reset updates per minute counter
      if (Date.now() - lastMinuteReset >= 60000) {
        document.getElementById('updateRate').textContent = updatesThisMinute;
        updatesThisMinute = 0;
        lastMinuteReset = Date.now();
      }
    }, 1000);
  </script>
</body>
</html>
